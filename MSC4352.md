# MSC4352: Customizable HTTPS Permalink Base URLs

This document describes the implementation of MSC4352 in iamb, which allows customizable HTTPS permalink base URLs for Matrix links.

## Features

### 1. Discovery of Custom Permalink Base URL

iamb can discover a custom permalink base URL from your homeserver's `.well-known/matrix/client` configuration:

```json
{
  "m.permalink_base_url": "https://links.example.org"
}
```

During the unstable period, the key `org.matrix.msc4352.permalink_base_url` is also supported.

### 2. `:permalink` Command

Generate permalinks for the current room or specific events:

```
:permalink                           # Generate room permalink
:permalink event $event:example.org  # Generate event permalink
```

The generated permalink will use:
1. Your configured custom base URL (if available)
2. Your homeserver's well-known discovered base URL (if available)
3. `https://matrix.to` as fallback

### 3. Send-time Conversion

When you send a message containing resolver-style HTTPS permalinks, iamb automatically:
- Preserves the original URL in the `body` field
- Converts to equivalent `matrix:` URI in the `formatted_body` `href` attribute

This ensures compatibility with all Matrix clients while allowing custom domains.

## Configuration

### Enable the Feature

Set the environment variable to enable MSC4352:

```bash
export IAMB_MSC4352=1
```

### Override Permalink Base (for testing)

You can override the permalink base URL:

```bash
export IAMB_MSC4352_PERMALINK_BASE=https://links.example.org
```

## Examples

### Basic Usage

1. Enable the feature:
   ```bash
   export IAMB_MSC4352=1
   ```

2. In a room, generate a permalink:
   ```
   :permalink
   ```

3. Output: `Permalink: https://links.example.org/#/!room:example.org?via=example.org (copied to clipboard)`

### Sending Links

When you type a message like:

```
Check out this room: https://links.example.org/#/%23room%3Aexample.org
```

The sent message will have:
- `body`: `"Check out this room: https://links.example.org/#/%23room%3Aexample.org"`
- `formatted_body`: `"Check out this room: <a href=\"matrix:r/room:example.org\">https://links.example.org/#/%23room%3Aexample.org</a>"`

## Technical Details

### Discovery Precedence

1. **User override**: `IAMB_MSC4352_PERMALINK_BASE` environment variable
2. **Well-known discovery**: `/.well-known/matrix/client` on your homeserver
3. **Default fallback**: `https://matrix.to`

### Supported Matrix Identifiers

- Room aliases: `#room:example.org`
- Room IDs: `!room:example.org`
- User IDs: `@user:example.org`
- Group IDs: `+group:example.org` (historical)

### Security

- Only HTTPS URLs are accepted as permalink bases
- Well-known discovery requires HTTPS
- Conversion only applies to outgoing messages, not in-app navigation

## Implementation Status

This is an unstable implementation of MSC4352. When the MSC is accepted:
- The well-known key will change from `org.matrix.msc4352.permalink_base_url` to `m.permalink_base_url`
- The feature may be enabled by default